<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SheetUtils.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GoaTE</a> &gt; <a href="index.source.html" class="el_package">com.thegoate.spreadsheets.utils</a> &gt; <span class="el_source">SheetUtils.java</span></div><h1>SheetUtils.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2017. Eric Angeli
 *
 *  Permission is hereby granted, free of charge,
 *  to any person obtaining a copy of this software
 *  and associated documentation files (the &quot;Software&quot;),
 *  to deal in the Software without restriction,
 *  including without limitation the rights to use, copy,
 *  modify, merge, publish, distribute, sublicense,
 *  and/or sell copies of the Software, and to permit
 *  persons to whom the Software is furnished to do so,
 *  subject to the following conditions:
 *
 *  The above copyright notice and this permission
 *  notice shall be included in all copies or substantial
 *  portions of the Software.
 *
 *  THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
 *  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 *  WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE
 *  AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 *  HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 *  WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
 *  DEALINGS IN THE SOFTWARE.
 */
package com.thegoate.spreadsheets.utils;

import com.thegoate.Goate;
import com.thegoate.annotations.AnnotationFactory;
import com.thegoate.logging.BleatBox;
import com.thegoate.logging.BleatFactory;

import java.io.File;
import java.io.Reader;
import java.lang.reflect.InvocationTargetException;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

/**
 * Defines the interface for interacting with a sheet.
 * Created by Eric Angeli on 9/14/2017.
 */
<span class="fc" id="L46">public abstract class SheetUtils {</span>
<span class="fc" id="L47">    protected final BleatBox LOG = BleatFactory.getLogger(getClass());</span>
<span class="fc" id="L48">    protected Goate data = new Goate();</span>
<span class="fc" id="L49">    protected String fileName = &quot;&quot;;</span>
<span class="fc" id="L50">    protected String sheetName = &quot;&quot; + System.nanoTime();</span>
<span class="fc" id="L51">    protected Map&lt;String, List&lt;String&gt;&gt; headers = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc" id="L52">    protected boolean firstRowIsHeader = true;</span>
<span class="fc" id="L53">    protected boolean loadAllData = false;</span>
<span class="fc" id="L54">    protected boolean trimWhiteSpace = false;</span>

<span class="fc" id="L56">    protected Object file = null;</span>

    public abstract int rowCount();

    public Goate getRow(int rowNumber) {
<span class="fc" id="L61">        return currentSheet().get(&quot;&quot; + rowNumber, new Goate(), Goate.class);</span>
    }

    public SheetUtils trim(boolean trimWhiteSpace){
<span class="fc" id="L65">        this.trimWhiteSpace = trimWhiteSpace;</span>
<span class="fc" id="L66">        return this;</span>
    }

    public boolean isTrimWhiteSpace(){
<span class="nc" id="L70">        return trimWhiteSpace;</span>
    }

    public Goate currentSheet() {
<span class="fc" id="L74">        return data.get(sheetName, new Goate(), Goate.class);</span>
    }

    public SheetUtils newFile(String fileName) {
<span class="fc" id="L78">        file(fileName);</span>
<span class="fc" id="L79">        return newFile();</span>
    }

    public SheetUtils newFile() {
<span class="fc" id="L83">        return createNew();</span>
    }

    public SheetUtils loadAllData() {
<span class="fc" id="L87">        this.loadAllData = true;</span>
<span class="fc" id="L88">        return this;</span>
    }

    public SheetUtils stopAtFirstEmptyRow() {
<span class="nc" id="L92">        this.loadAllData = false;</span>
<span class="nc" id="L93">        return this;</span>
    }

    public abstract SheetUtils createNew();

    public SheetUtils file(File file) {
<span class="fc" id="L99">        this.file = file;</span>
<span class="fc" id="L100">        return this;</span>
    }

    public SheetUtils file(Reader file) {
<span class="nc" id="L104">        this.file = file;</span>
<span class="nc" id="L105">        return this;</span>
    }

    public SheetUtils file(String fileName) {
<span class="fc" id="L109">        this.fileName = fileName;</span>
<span class="fc" id="L110">        return this;</span>
    }

    public SheetUtils sheet(String sheetName) {
<span class="fc" id="L114">        this.sheetName = sheetName;</span>
<span class="fc" id="L115">        return this;</span>
    }

    public String sheetName() {
<span class="fc" id="L119">        return sheetName;</span>
    }

    public List&lt;String&gt; headers() {
<span class="fc" id="L123">        return headers(sheetName);</span>
    }

    public List&lt;String&gt; headers(String sheetName) {
<span class="fc bfc" id="L127" title="All 2 branches covered.">        return headers.get(sheetName) == null ? new ArrayList&lt;&gt;() : headers.get(sheetName);</span>
    }

    public SheetUtils firstRowIsNotHeader() {
<span class="fc" id="L131">        this.firstRowIsHeader = false;</span>
<span class="fc" id="L132">        return this;</span>
    }

    public SheetUtils firstRowIsHeader() {
<span class="fc" id="L136">        this.firstRowIsHeader = true;</span>
<span class="fc" id="L137">        return this;</span>
    }

    public SheetUtils firstRowIsHeader(boolean firstRowIsHeader) {
<span class="fc" id="L141">        this.firstRowIsHeader = firstRowIsHeader;</span>
<span class="fc" id="L142">        return this;</span>
    }

    public Goate getData() {
<span class="nc" id="L146">        return data;</span>
    }

    public abstract Goate load();

    public Object get(int col, int row) {
<span class="fc" id="L152">        return get(col, row, null);</span>
    }

    protected String getColId(int col){
<span class="fc" id="L156">        String colId = &quot;&quot; + col;</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">        if (firstRowIsHeader) {</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">            if (col &lt; headers.get(sheetName).size()) {</span>
<span class="fc" id="L159">                colId = headers.get(sheetName).get(col);</span>
            }
        }
<span class="fc" id="L162">        return colId;</span>
    }

    public Object get(int col, int row, Object def) {
<span class="fc" id="L166">        String colId = getColId(col);</span>
<span class="fc" id="L167">        return get(colId, row, def);</span>
    }

    public Object get(String col, int row) {
<span class="fc" id="L171">        return get(col, row, null);</span>
    }

    public Object get(String col, int row, Object def) {
<span class="fc" id="L175">        setHeaderIfNotSet(col);</span>
<span class="fc" id="L176">        return currentSheet().get(&quot;&quot; + row, new Goate(), Goate.class).get(col, def);</span>
    }

    public SheetUtils setHeaderIfNotSet(String header){
<span class="fc bfc" id="L180" title="All 2 branches covered.">        if(!headers().stream().anyMatch(h -&gt; h.equals(header))){</span>
<span class="fc" id="L181">            setHeader(headers().size(), header);</span>
        }
<span class="fc" id="L183">        return this;</span>
    }

    public SheetUtils setHeader(int col, String header) {
<span class="fc" id="L187">        List&lt;String&gt; pageHeaders = checkHeaders(col + 1);</span>
<span class="fc" id="L188">        pageHeaders.set(col, header);</span>
<span class="fc" id="L189">        return this;</span>
    }

    public List&lt;String&gt; checkHeaders(int size) {
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">        if (headers == null) {</span>
<span class="nc" id="L194">            headers = new ConcurrentHashMap&lt;&gt;();</span>
        }
<span class="fc" id="L196">        headers.computeIfAbsent(sheetName, k -&gt; new ArrayList&lt;&gt;());</span>
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">        if (headers.get(sheetName).size() &lt; size) {</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">            for (int i = headers.get(sheetName).size(); i &lt; size; i++) {</span>
<span class="fc" id="L199">                headers.get(sheetName).add(&quot;&quot;);</span>
            }
        }
<span class="fc" id="L202">        return headers.get(sheetName);</span>
    }

    public SheetUtils set(int col, int row, Object value) {
<span class="fc" id="L206">        String colId = getColId(col);</span>
<span class="fc" id="L207">        return set(colId, row, value);</span>
    }

    public SheetUtils set(String col, int row, Object value) {
<span class="fc" id="L211">        setHeaderIfNotSet(col);</span>
<span class="fc" id="L212">        Goate page = currentSheet();</span>
<span class="fc" id="L213">        Goate rowData = page.get(&quot;&quot; + row, new Goate(), Goate.class);</span>
<span class="fc" id="L214">        rowData.put(col, value);</span>
<span class="fc" id="L215">        return this;</span>
    }

    public abstract SheetUtils writeToFile();

    public abstract SheetUtils close();

    public static SheetUtils build(String fileName) throws IllegalAccessException, InvocationTargetException, InstantiationException {
<span class="fc" id="L223">        return build(fileName, (String) null);</span>
    }

    public static SheetUtils build(String fileName, File file) throws IllegalAccessException, InvocationTargetException, InstantiationException {
<span class="nc" id="L227">        return build(fileName, null, file);</span>
    }

    public static SheetUtils build(String fileName, Reader in) throws IllegalAccessException, InvocationTargetException, InstantiationException {
<span class="nc" id="L231">        return build(fileName, null, in);</span>
    }

    public static SheetUtils build(String fileName, String sheetName) throws IllegalAccessException, InvocationTargetException, InstantiationException {
<span class="fc" id="L235">        return build(fileName, sheetName, (File) null);</span>
    }

    public static SheetUtils build(String fileName, String sheetName, File file) throws IllegalAccessException, InvocationTargetException, InstantiationException {
<span class="fc" id="L239">        return getUtil(getExt(fileName)).file(fileName).sheet(sheetName).file(file);</span>
    }

    public static SheetUtils build(String fileName, String sheetName, Reader file) throws IllegalAccessException, InvocationTargetException, InstantiationException {
<span class="nc" id="L243">        SheetUtils util = getUtil(getExt(fileName));</span>
<span class="nc" id="L244">        util.file(fileName);</span>
<span class="nc" id="L245">        util.sheet(sheetName);</span>
<span class="nc" id="L246">        util.file(file);</span>
<span class="nc" id="L247">        return util;</span>
    }

    protected static String getExt(String fileName) {
<span class="fc" id="L251">        String ext = &quot;&quot;;</span>
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">        int extIndex = fileName == null ? -1 : fileName.lastIndexOf(&quot;.&quot;);</span>
<span class="pc bpc" id="L253" title="2 of 4 branches missed.">        if (extIndex &gt;= 0 &amp;&amp; extIndex &lt; fileName.length() - 1) {</span>
<span class="fc" id="L254">            ext = fileName.substring(extIndex + 1);</span>
        }
<span class="fc bfc" id="L256" title="All 4 branches covered.">        if(!ext.equalsIgnoreCase(&quot;xls&quot;)&amp;&amp;!ext.equalsIgnoreCase(&quot;xlsx&quot;)){</span>
<span class="fc" id="L257">            ext = &quot;csv&quot;;</span>
        }
<span class="fc" id="L259">        return ext;</span>
    }

    protected static SheetUtils getUtil(String ext) throws IllegalAccessException, InvocationTargetException, InstantiationException {
<span class="fc" id="L263">        AnnotationFactory af = new AnnotationFactory();</span>
<span class="fc" id="L264">        af.annotatedWith(GoateSheet.class).find(ext).using(&quot;fileTypes&quot;);</span>
<span class="fc" id="L265">        return (SheetUtils) af.build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>